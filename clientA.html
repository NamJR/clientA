<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Client A</title>
</head>
<body>
    <h1>WebRTC Client A</h1>
    <button id="startCallButton">Start Call</button>
    <button id="pauseStreamButton">Pause Stream</button>
    <button id="resumeStreamButton" disabled>Resume Stream</button> 
    <video id="localVideo" autoplay playsinline muted></video>
    <video id="remoteVideo" autoplay playsinline></video>

    <script>
        const SERVER_URL = "http://192.168.1.165:5221/api/Signal";
        let localConnection;
        let connectionId = null;
        let localStream;

        async function getLocalVideoStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                return localStream;
            } catch (err) {
                console.error("âŒ Failed to get local stream:", err);
                throw err;
            }
        }

        async function startCall() {
            try {
                console.log("ðŸ“ž Starting call...");
                localStream = await getLocalVideoStream();
                if (!localStream) throw new Error("âŒ No local stream available!");

                localConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: "stun:stun.l.google.com:19302" },
                        { urls: "stun:stun1.l.google.com:19302" },
                        { urls: "turn:turn.example.com:3478", username: "user", credential: "password" }
                    ]
                });

                localStream.getTracks().forEach(track => localConnection.addTrack(track, localStream));

                localConnection.onicecandidate = event => {
                    if (event.candidate) {
                        sendIceCandidate(event.candidate);
                    }
                };

                localConnection.ontrack = event => {
                    console.log("ðŸ“¡ Received track from Client B:", event.streams[0]);
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };

                // Táº¡o offer
                const offer = await localConnection.createOffer();

                // Thay Ä‘á»•i IP trong SDP
                let offerSDP = offer.sdp.replace("127.0.0.1", "192.168.1.72");  // Thay tháº¿ Ä‘á»‹a chá»‰ IP loopback vá»›i IP LAN
                await localConnection.setLocalDescription(new RTCSessionDescription({ type: 'offer', sdp: offerSDP }));

                console.log("ðŸ“¡ Sending Offer to server...");
                const response = await fetch(`${SERVER_URL}/offer`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sdp: offerSDP, type: 'offer' }),  // Gá»­i SDP Ä‘Ã£ thay Ä‘á»•i
                });

                if (!response.ok) throw new Error("âŒ Server rejected the offer.");

                const responseData = await response.json();
                connectionId = responseData.connectionId;
                console.log("ðŸ”— Connection ID:", connectionId);

                await fetchAnswer();
            } catch (error) {
                console.error("ðŸš¨ Error in startCall:", error);
            }
        }

        async function sendIceCandidate(candidate) {
            if (!connectionId) return;
            try {
                await fetch(`${SERVER_URL}/candidate/${connectionId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(candidate),
                });
            } catch (error) {
                console.error("ðŸš¨ Error sending ICE Candidate:", error);
            }
        }

        async function fetchAnswer() {
            let retries = 20;
            while (retries-- > 0) {
                try {
                    const response = await fetch(`${SERVER_URL}/answer/${connectionId}`);
                    if (response.ok) {
                        const answer = await response.json();
                        await localConnection.setRemoteDescription(new RTCSessionDescription(answer));
                        console.log("ðŸŽ‰ Connection established!");
                        fetchIceCandidates();
                        return;
                    }
                } catch (error) {
                    console.error("ðŸš¨ Error fetching Answer:", error);
                }
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            console.error("âŒ Failed to get Answer after retries. Check if Client B has responded.");
        }

        async function fetchIceCandidates() {
            setInterval(async () => {
                if (!connectionId || !localConnection.remoteDescription) return;
                try {
                    const response = await fetch(`${SERVER_URL}/candidate/${connectionId}`);
                    if (response.ok) {
                        const candidates = await response.json();
                        candidates.forEach(candidate => {
                            localConnection.addIceCandidate(new RTCIceCandidate(candidate)).catch(err => {
                                console.error("ðŸš¨ Error adding ICE Candidate:", err);
                            });
                        });
                    }
                } catch (error) {
                    console.error("ðŸš¨ Error fetching ICE Candidate:", error);
                }
            }, 1000);
        }

        // ðŸŽ¥ Táº¡m dá»«ng video
        function pauseStream() {
            if (!localStream) return;
            localStream.getTracks().forEach(track => track.enabled = false);
            console.log("â¸ Stream Paused");
            document.getElementById('pauseStreamButton').disabled = true;
            document.getElementById('resumeStreamButton').disabled = false;
        }

        // ðŸŽ¥ Tiáº¿p tá»¥c video
        function resumeStream() {
            if (!localStream) return;
            localStream.getTracks().forEach(track => track.enabled = true);
            console.log("â–¶ Stream Resumed");
            document.getElementById('pauseStreamButton').disabled = false;
            document.getElementById('resumeStreamButton').disabled = true;
        }

        document.getElementById('startCallButton').addEventListener('click', startCall);
        document.getElementById('pauseStreamButton').addEventListener('click', pauseStream);
        document.getElementById('resumeStreamButton').addEventListener('click', resumeStream);
    </script>
</body>
</html>
